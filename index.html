<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <title>Field Book</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <header>
    <div class="header-left">
      <i class="fas fa-leaf"></i>&nbsp<span class="header-title">Field Book</span>
    </div>
    <div class="header-right"><i class="fas fa-user">&nbsp</i>
      <span id="user-name"></span>
      <button onclick="logout()" class="logout-btn">Odjava</button>
    </div>
  </header>

  <div class="content">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Parcele</h2>
      </div>

      <div class="parcel-controls">
        <input type="checkbox" id="parcelCheck" onclick="layerOn()" checked>
        <i class="fas fa-map-marked-alt"></i>&nbsp
        <label for="parcelCheck">PARCELE</label>
      </div>

      <ul id="lista-parcela"></ul>

      <!--  <ul id="lista-parcela" class="parcel-list"></ul>-->

<!--
      <div class="parcel-section">
        <h3>Dodaj novu parcelu</h3>
        <button id="addParcelBtn">
          <i class="fas fa-plus"></i> Dodaj
        </button>
      </div>
-->
      <div>
        <h3>Plodored</h3>
        <div id="plodored">Odaberite parcelu za prikaz plodoreda.</div>
      </div>

    </aside>

    <main class="main-content">

      <div class="parcel-details">
        <h3>Detalji parcele</h3>
        <p>Izaberite parcelu sa liste za prikaz detalja</p>

        <div class="parcel-info-grid">
          <div class="info-item">
            <span class="info-label">Interni broj:</span>
            <span class="info-value" id="interni-broj">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Katastarska čestica:</span>
            <span class="info-value" id="katastarska-cestica">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Katastarska opština:</span>
            <span class="info-value" id="katastarska-opstina">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Potez:</span>
            <span class="info-value" id="potez">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Vlasnik zemljišta:</span>
            <span class="info-value" id="vlasnik">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Udio u vlasničkoj strukturi:</span>
            <span class="info-value" id="udio">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Način korišćenja:</span>
            <span class="info-value" id="nacin-koriscenja">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Klasa zemljišta:</span>
            <span class="info-value" id="klasa">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Površina:</span>
            <span class="info-value" id="povrsina">-</span>
          </div>
          <div class="info-item full-width">
            <span class="info-label">Napomena:</span>
            <span class="info-value" id="napomena">-</span>
          </div>
        </div>
      </div>

      <div id="map"></div>

    </main>
  </div>

  <footer class="footer">
    <p>FieldBook &copy; 2025</p>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <script>
    function logout() {
      localStorage.removeItem("user_id");
      localStorage.removeItem("username");
      window.location.href = "login.html";
    }

    const userId = localStorage.getItem('user_id');
    const username = localStorage.getItem('username');

    if (!userId) {
      // Ako korisnik nije ulogovan, prebaci na login
      window.location.href = 'login.html';
    }

    // Postavi ime korisnika u zaglavlje (ako postoji element)
    const userSpan = document.getElementById('user-name');
    if (userSpan && username) {
      userSpan.textContent = `${username}`;
    }

    // TODO: Kad rješimo rutu /field-book/<user_id> koristi je ovako:
    //fetch(`http://127.0.0.1:5000/field-book/1`)

  </script>

  <script>


    // Ovaj kod učitava prostorne podatke parcela sa servera, prikazuje ih kao klikabilne stavke u listi na stranici
    // i na klik zumira mapu na odabranu parcelu, dok istovremeno prikazuje dodatne detalje.
    var map = L.map('map').setView([45.03, 18.45], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var parceleLayer = L.layerGroup().addTo(map);

    const highlightLayer = L.geoJSON(null, {
      style: {
        color: 'orange',
        weight: 3,
        fillOpacity: 0.2
      }
    }).addTo(map);

    // Funkcija za generisanje popup sadržaja
    function getPopupText(props) {
      return `
        <b>ID:</b> ${props.id}<br>
        <b>Broj:</b> ${props.broj}<br>
        <b>Opština:</b> ${props.opstina}
      `;
    }


    fetch(`https://fieldbook-app.onrender.com/field-book/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error("Server vraca gresku:", data.error);
          return;
        }

        const lista = document.getElementById('lista-parcela');
        data.features.forEach(feature => {
          const props = feature.properties;
          const geom = feature.geometry;

          const li = document.createElement('li');
          li.innerHTML = getPopupText(props);
          li.style.cursor = "cursor";
          //li.style.cursor = map.hasLayer(parceleLayer) ? "pointer" : "default";

          if (!document.getElementById('parcelCheck').checked) {
            //li.style.pointerEvents = "none";
            //li.style.opacity = "0.5";
            //return alert('test');
          }


          li.addEventListener("click", () => {
            if (!map.hasLayer(parceleLayer)) {
              const upozorenje = document.getElementById("plodored");
              upozorenje.innerHTML = ('Layer parcele je isključen. Ne možete selektovati parcelu');
              return;
            }
            prikaziDetalje(props);

            if (li.classList.contains("selected")) {
              return; // već selektovana – ne radi ništa
            }

            document.querySelectorAll("#lista-parcela li").forEach(el => el.classList.remove("selected"));
            li.classList.add("selected");


            if (geom?.type === "Polygon") {
              const polygon = {
                type: "Feature",
                geometry: geom,
                properties: props
              };

              // Očisti prethodni highlight i dodaj novi
              highlightLayer.clearLayers();
              highlightLayer.addData(polygon);

              const coordinates = geom.coordinates[0].map(([lng, lat]) => [lat, lng]);
              const bounds = L.latLngBounds(coordinates);
              map.fitBounds(bounds);

              L.popup()
                .setLatLng(bounds.getCenter())
                .setContent(getPopupText(props))
                .openOn(map);
            }
          });
          lista.appendChild(li);
        });

        //Prikaz na mapi
        L.geoJSON(data, {
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            if (!props) return;

            layer.bindPopup(getPopupText(props));

            layer.on("click", () => {
              prikaziDetalje(props);

              // Selektuj geometriju
              highlightLayer.clearLayers();
              highlightLayer.addData(feature);

              // Otvori popup na centru geometrije
              if (feature.geometry?.type === "Polygon") {
                const coords = feature.geometry.coordinates[0].map(([lng, lat]) => [lat, lng]);
                const center = L.latLngBounds(coords).getCenter();

                L.popup()
                  .setLatLng(center)
                  .setContent(getPopupText(props))
                  .openOn(map);
              }
            });
          }
        }).addTo(parceleLayer);
      })

      .catch(error => {
        console.error("Greška prilikom preuzimanja podataka:", error);
      });

    function layerOn() {
      const checkbox = document.getElementById("parcelCheck");

      if (checkbox.checked) {
        parceleLayer.addTo(map);
        document.getElementById("plodored").innerHTML = "Odaberite parcelu za prikaz plodoreda."
      } else {
        map.removeLayer(parceleLayer); // Ukloni sloj sa mape
        map.closePopup(); // Ukloni popup
        highlightLayer.clearLayers(); // Očisti highlight sloj
        document.getElementById("plodored").innerHTML = "Layer parcele je isključen. Uključite layer, da biste vidjeli informacije o plodoredu.";// (opciono) Očisti prikaz plodoreda
        document.querySelectorAll("#lista-parcela li").forEach(el => el.classList.remove("selected")); // Ukloni selektovani stil iz liste
      }
    }

    map.on("click", function() {
      map.closePopup();
      highlightLayer.clearLayers();
      document.querySelectorAll("#lista-parcela li").forEach(el => el.classList.remove("selected"));
      prikaziDetalje(null);
    });

    function prikaziDetalje(p) {
      const polja = {
        "interni-broj": p?.broj || "-",
        "katastarska-cestica": p?.kc || "-",
        "katastarska-opstina": p?.opstina || "-",
        "potez": p?.potez || "-",
        "vlasnik": p?.vlasnik || "-",
        "udio": p?.udio || "-",
        "nacin-koriscenja": p?.nacin || "-",
        "klasa": p?.klasa || "-",
        "povrsina": p?.povrsina ? `${p.povrsina.toFixed(2)} m²` : "-",
        "napomena": p?.napomena || "-"
      };

      for (const [id, value] of Object.entries(polja)) {
        document.getElementById(id).textContent = value;
      }

      // Plodored
      const prikaz = document.getElementById("plodored");
      if (!p?.id) {
        prikaz.innerHTML = "<p>Odaberite parcelu za prikaz plodoreda</p>";
        return;
      }




      fetch(`https://fieldbook-app.onrender.com/plodored/${p.id}`)
        .then(response => response.json())
        .then(plodored => {
          const prikaz = document.getElementById("plodored");
          if (plodored.error) {
            prikaz.innerHTML = "<i>Plodored podaci nisu dostupni.</i>";
            return;
          }

          // Prikaz liste plodoreda
          let html = "<ul>";
          plodored.forEach(item => {
            html += `<li><b>${item.godina}:</b> ${item.kultura} (${item.napomena || "nema napomene"})</li>`;
          });
          html += "</ul>";
          prikaz.innerHTML = html;
        })
        .catch(err => {
          console.error("Greška pri dohvatanju plodoreda:", err);
          document.getElementById("plodored").innerHTML = "<i>Greška pri učitavanju plodoreda.</i>";
        });
    }

  </script>
</body>


</html>
