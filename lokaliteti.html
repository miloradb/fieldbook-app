<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <title>Field Book</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <header>
    <div class="header-left">
      <i class="fas fa-leaf"></i>&nbsp<span class="header-title">Field Book</span>
    </div>
    <div class="header-right"><i class="fas fa-user">&nbsp</i>
      <span id="user-name"></span>
      <button onclick="logout()" class="logout-btn">Odjava</button>
    </div>
  </header>

  <div class="content">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Aplikacija Field Book</h2>

        <ul class="sidebar-menu">
          <li class="menu-item">
            <a href="index.html" class="menu-link">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="menu-item">
            <a href="lokaliteti.html" class="menu-link active">
              <i class="fas fa-map-marked-alt"></i>
              <span>Lokaliteti</span>
            </a>
          </li>
        </ul>
      </div>

      <h3>Lista parcela</h3>
      <ul id="lista-parcela"></ul>

      <div>
        <h3>Plodored</h3>
        <div id="plodored">Odaberite parcelu za prikaz plodoreda.</div>
      </div>

    </aside>

    <main class="main-content">

      <div class="cards-grid">
        <div class="card">
          <div class="card-header">
            <h3 card="card-title">Ukupno parcela za obradu</h3>
            <div  class="card-icon primary">
              <i class="fas fa-map-marked-alt"></i>
            </div>
          </div>
          <div id='ukupnoParcela' class="card-value"></div>
          <div id='ukupnoParcelaValue' class="card-description"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">test</h3>
            <div  class="card-icon primary">
              <i class="fas fa-map-marked-alt"></i>
            </div>
          </div>
          <div id="ugovor-status1" class="card-value">test</div>
          <div id="ugovor-raspisan1" class="card-description">test</div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">test</h3>
            <div  class="card-icon primary">
              <i class="fas fa-map-marked-alt"></i>
            </div>
          </div>
          <div id="ugovor-status2" class="card-value">test</div>
          <div id="ugovor-raspisan2" class="card-description">test</div>
        </div>

      </div>

      <div class="bottom-section">
        <div class="parcel-details" id="desktop-only">
          <h3>Detalji parcele</h3>
          <p>Izaberite parcelu sa liste za prikaz detalja:</p>

          <div class="parcel-info-grid">
            <div class="info-item">
              <span class="info-label">Interni broj:</span>
              <span class="info-value" id="interni-broj">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Katastarska čestica:</span>
              <span class="info-value" id="katastarska-cestica">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Katastarska opština:</span>
              <span class="info-value" id="katastarska-opstina">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Potez:</span>
              <span class="info-value" id="potez">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Vlasnik zemljišta:</span>
              <span class="info-value" id="vlasnik">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Udio u vlasničkoj strukturi:</span>
              <span class="info-value" id="udio">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Način korišćenja:</span>
              <span class="info-value" id="nacin-koriscenja">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Klasa zemljišta:</span>
              <span class="info-value" id="klasa">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Površina:</span>
              <span class="info-value" id="povrsina">-</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Napomena:</span>
              <span class="info-value" id="napomena">-</span>
            </div>
          </div>
        </div>











        <!-- OVO JE ACCORDION ZA MOBILNU VERZIJU, RADI PREGLEDNOSTO -->

        <details  class="parcel-details" id="mobile-only">
          <summary>Detalji parcele</summary>
          <p>Izaberite parcelu sa liste za prikaz detalja:</p>

          <div class="parcel-info-grid">
            <div class="info-item">
              <span class="info-label">Interni broj:</span>
              <span class="info-value" id="mob-interni-broj">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Katastarska čestica:</span>
              <span class="info-value" id="mob-katastarska-cestica">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Katastarska opština:</span>
              <span class="info-value" id="mob-katastarska-opstina">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Potez:</span>
              <span class="info-value" id="mob-potez">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Vlasnik zemljišta:</span>
              <span class="info-value" id="mob-vlasnik">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Udio u vlasničkoj strukturi:</span>
              <span class="info-value" id="mob-udio">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Način korišćenja:</span>
              <span class="info-value" id="mob-nacin-koriscenja">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Klasa zemljišta:</span>
              <span class="info-value" id="mob-klasa">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">Površina:</span>
              <span class="info-value" id="mob-povrsina">-</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Napomena:</span>
              <span class="info-value" id="mob-napomena">-</span>
            </div>
          </div>
        </details>



        <div id="prinosi">
          <h3>Prinosi</h3>
          <p>Izaberite parcelu sa liste za prikaz detalja:</p>
          <div>
            <table id="prinosiPrikaz">
              <thead>
                <tr>
                  <th>Godina</th>
                  <th>Kultura</th>
                  <th>Prinos (kg)</th>
                  <th>Napomena</th>
                </tr>
              </thead>
              <tbody>
                <!-- Redovi će se puniti preko JavaScript-a -->
              </tbody>
            </table>
          </div>
        </div>


      </div>
    </main>
  </div>

  <footer class="footer">
    <p>FieldBook &copy; 2025</p>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <script>
    function logout() {
        localStorage.removeItem("user_id");
        localStorage.removeItem("username");
        window.location.href = "login.html";
    }

    const userId = localStorage.getItem('user_id');
    const username = localStorage.getItem('username');

    if (!userId) {
        // Ako korisnik nije ulogovan, prebaci na login
        window.location.href = 'login.html';
    }

    // Postavi ime korisnika u zaglavlje (ako postoji element)
    const userSpan = document.getElementById('user-name');
    if (userSpan && username) {
        userSpan.textContent = `${username}`;
    }

  </script>



  <script>

    function getParcelData(props) {
      return `
        <b>ID:</b> ${props.id}<br>
        <b>Broj:</b> ${props.broj}<br>
        <b>Opština:</b> ${props.opstina}
      `;
    }

    function getPlodoredData(propsPlodored) {
      return `
        <b>${propsPlodored.godina}: </b>${propsPlodored.kultura} (${propsPlodored.napomena || "nema napomene"})
      `;
    }


    fetch(`https://fieldbook-app.onrender.com/field-book/${userId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error("Server vraca gresku: ", data.error);
          return;
        }

        const lista = document.getElementById('lista-parcela');

        const ukupnoParcela = document.getElementById("ukupnoParcela")
        ukupnoParcela.textContent = data.features.length;
        
        data.features.forEach(feature => {
          const props = feature.properties;
          const li = document.createElement('li');
          li.innerHTML = getParcelData(props);
          
          li.addEventListener("click", () => {
            // 1. Ukloni 'selected' sa svih li elemenata unutar liste
            document.querySelectorAll('#lista-parcela li').forEach(el => {
              el.classList.remove('selected');
            });
            //Dodaj "selected" na kliknuti element
            li.classList.add('selected')

            // 3. Prikaži detalje
            prikaziDetalje(props);
          })    
          
          lista.appendChild(li);
        });
        
      })

      .catch(error => {
        console.error("Greska pri fetchovanju: ", error);
      });



    function prikaziDetalje(p) {
      const polja = {
        "interni-broj": p?.broj || "-",
        "katastarska-cestica": p?.kc || "-",
        "katastarska-opstina": p?.opstina || "-",
        "potez": p?.potez || "-",
        "vlasnik": p?.vlasnik || "-",
        "udio": p?.udio || "-",
        "nacin-koriscenja": p?.nacin || "-",
        "klasa": p?.klasa || "-",
        "povrsina": p?.povrsina ? `${p.povrsina.toFixed(2)} m²` : "-",
        "napomena": p?.napomena || "-"
      };

      for (const [id, value] of Object.entries(polja)) {
        document.getElementById(id).textContent = value;
        const mobEl = document.getElementById("mob-" + id);
        if (mobEl) mobEl.textContent = value;
      }
    
    
      fetch(`https://fieldbook-app.onrender.com/plodored/${p.id}`)
        .then(response => response.json())
        .then(plodored => {
          const plodoredPodaci = document.getElementById("plodored");
          const ul = document.createElement("ul");  // napravi ul
          plodoredPodaci.innerHTML = "";

          if (plodored.error) {
            /*console.warn("Server vraca gresku za plodored: ", plodored.warn)*/
            plodoredPodaci.innerHTML = "<i>Podaci za plodored nisu dostupni.</i>";
            return;
          }
            
            

            plodored.forEach(propsPlodored => {
              const li = document.createElement('li');
              li.innerHTML = getPlodoredData(propsPlodored);
              ul.appendChild(li);
            });
            plodoredPodaci.appendChild(ul);
        });




        function getPrinosiData(propsPrinosi) {
          return `
            ${propsPrinosi.godina} ${propsPrinosi.kultura} ${propsPrinosi.prinos_kg} ${propsPrinosi.napomena}
          `;
        }


      fetch(`https://fieldbook-app.onrender.com/prinosi/${p.id}`


      //Ovo je kod za unos u tabelu
      .then (response => response.json())
      .then(prinosi => {
        const tabelaPrinos = document.getElementById("prinosiPrikaz");
        const tabelaBody = tabelaPrinos.querySelector("tbody");
        tabelaBody.innerHTML = "";   //ocisti prethodne redove

        if (!prinosi || prinosi.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.innerHTML = "<i>Podaci za prinos nisu dostupni.</i>";
          tr.appendChild(td);
          tabelaBody.appendChild(tr);
          return;
        }
        
        prinosi.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.godina}</td>
            <td>${p.kultura}</td>
            <td>${p.prinos_kg}</td>
            <td>${p.napomena || ''}</td>
          `;
          tabelaBody.appendChild(tr);
        });
      })

      .catch(error => {
        console.error("Greška pri učitavanju podataka za prinos: ", error);
      });




    }  


  </script>


</body>


</html>
